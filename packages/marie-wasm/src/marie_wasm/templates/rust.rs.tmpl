// Marie Node Rust Wrapper
// Aligned with Cloudflare Workers naming conventions
//
// This wrapper is injected around user code to provide:
// - Panic handling with structured responses
// - Input/env/context injection
// - Return type validation

#![allow(unused_imports)]

use std::panic::{catch_unwind, AssertUnwindSafe};

// WIT bindings generated by wit-bindgen
// Types available: Guest, Item, Env, Context, Response
wit_bindgen::generate!({
    world: "node",
    path: "/opt/wit",
    generate_all,
});

// ============================================
// USER CODE START
// User defines: fn execute(input: Vec<Item>, env: Env, ctx: Context) -> Response
// ============================================

{USER_CODE}

// ============================================
// USER CODE END
// ============================================

struct Component;

impl Guest for Component {
    /// Wrapper that calls user's execute function with panic handling.
    fn execute(input: Vec<Item>, env: Env, ctx: Context) -> Response {
        let result = catch_unwind(AssertUnwindSafe(|| {
            execute(input, env, ctx)
        }));

        match result {
            Ok(response) => response,
            Err(panic_info) => {
                let panic_msg = if let Some(s) = panic_info.downcast_ref::<&str>() {
                    s.to_string()
                } else if let Some(s) = panic_info.downcast_ref::<String>() {
                    s.clone()
                } else {
                    "Unknown panic occurred".to_string()
                };
                Response::Err(format!("Execution panic: {}", panic_msg))
            }
        }
    }
}

export!(Component);
