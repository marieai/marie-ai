# Health
<source>
  @type monitor_agent
  bind 0.0.0.0
  port 24220
</source>

# Tail the json-file log (hard-coded full ID)
<source>
  @type tail
  path "/var/lib/docker/containers/#{ENV['TARGET_CONTAINER_ID']}/#{ENV['TARGET_CONTAINER_ID']}-json.log"
  pos_file /fluentd/state-json.pos
  tag app.docker.json
  read_from_head false
  refresh_interval 5
  <parse>
    @type json
    time_key time
    time_format %Y-%m-%dT%H:%M:%S.%L
  </parse>
</source>

<filter app.docker.json>
  @type record_transformer
  enable_ruby true
  <record>
    # remove ANSI + strip single trailing newline
    log_clean ${record["log"] ? record["log"].gsub(/\e\[[0-9;]*m/, '').gsub(/\r?\n\z/, '') : nil}
  </record>
</filter>


# Fan out to pipelines
<match app.docker.json>
  @type copy
  <store>
    @type relabel
    @label @CUDA_HEAL
  </store>
  <store>
    @type relabel
    @label @ASSERT_HEAL
  </store>
</match>

<label @CUDA_HEAL>
  <filter **>
    @type grep
    <regexp>
      key log_clean
      pattern /(?:(?:runtime|outofmemory)error:\s*)?cuda\s+out\s+of\s+memory|torch\.outofmemoryerror|cudaerrormemoryallocation|cublas_status_alloc_failed|cudnn.*alloc|failed\s+to\s+alloc(?:ate)?\s+.*device\s+memory/i
    </regexp>
  </filter>
  <match **>
    @type copy
    <store>
      @type stdout          # DEBUG: shows matched records
    </store>

<store>
  @type exec
  command "/bin/sh -lc '/etc/marie/config/extract/observability/fluentd/trigger_restart.sh >> /tmp/marie-healer/restart_script_error.log 2>&1'"  
  format json
  <buffer>
    @type memory
    flush_interval 1s
  </buffer>
</store>

  </match>
</label>

<label @ASSERT_HEAL>
  <filter **>
    @type grep
    <regexp>
      key log_clean
      pattern /assertion\s+failed/i
    </regexp>
  </filter>
  <match **>
    @type copy
    <store>
      @type stdout          # DEBUG: shows matched records
    </store>
    <store>
  @type exec
  command "/bin/sh -lc '/etc/marie/config/extract/observability/fluentd/trigger_restart.sh >> /tmp/marie-healer/restart_script_error.log 2>&1'"  
  format json
  <buffer>
    @type memory
    flush_interval 1s
  </buffer>
</store>
</match>
</label>

