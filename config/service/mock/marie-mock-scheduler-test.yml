jtype: Flow
version: '1'

# Configuration for testing scheduler with multiple mock executors
# This config creates 8 different mock executors (mock_executor_a through mock_executor_h)
# with varying processing times and failure rates to test scheduler behavior

# Shared configuration
shared_config:
  storage: &storage
    psql: &psql_conf_shared
      provider: postgresql
      hostname: ${{ ENV.POSTGRES_HOSTNAME }}
      port: 5432
      username: ${{ ENV.POSTGRES_USER }}
      password: ${{ ENV.POSTGRES_PASSWORD }}
      database: postgres
      default_table: shared_docs

  message: &message
    rabbitmq: &rabbitmq_conf_shared
      provider: rabbitmq
      hostname: ${{ ENV.RABBIT_MQ_HOSTNAME }}
      port: ${{ ENV.RABBIT_MQ_PORT }}
      username: ${{ ENV.RABBIT_MQ_USERNAME }}
      password: ${{ ENV.RABBIT_MQ_PASSWORD }}
      tls: False
      virtualhost: /


# Toast event tracking system
# It can be backed by Message Queue and Database backed
toast:
  native:
    enabled: True
    path: /tmp/marie/events.json
  rabbitmq:
    <<: *rabbitmq_conf_shared
    enabled: True
  psql:
    <<: *psql_conf_shared
    schema: marie_scheduler
    default_table: event_tracking
    enabled : True

# Document Storage
# The storage service is used to store the data that is being processed
# Storage can be backed by S3 compatible

storage:
  # S3 configuration. Will be used only if value of backend is "s3"
  s3: &s3_conf_shared
    enabled: True
    metadata_only: False # If True, only metadata will be stored in the storage backend
    # api endpoint to connect to. use AWS S3 or any S3 compatible object storage endpoint.
    endpoint_url: ${{ ENV.S3_ENDPOINT_URL }}
    # optional.
    # access key id when using static credentials.
    access_key_id: ${{ ENV.S3_ACCESS_KEY_ID }}
    # optional.
    # secret key when using static credentials.
    secret_access_key: ${{ ENV.S3_SECRET_ACCESS_KEY }}
    # Bucket name in s3
    bucket_name: ${{ ENV.S3_BUCKET_NAME }}
    # optional.
    # Example: "region: us-east-2"
    region: ${{ ENV.S3_REGION }}
    # optional.
    # enable if endpoint is http
    insecure: True
    # optional.
    # enable if you want to use path style requests
    addressing_style: path

  # postgresql configuration. Will be used only if value of backend is "psql"
  psql:
    <<: *psql_conf_shared
    schema: marie_scheduler
    default_table: store_metadata
    enabled: False

# Job Queue scheduler
scheduler:
  psql:
    <<: *psql_conf_shared
    schema: marie_scheduler
    default_table: job_queue
    enabled : True

# LLM Tracking configuration
llm_tracking:
  enabled: true
  exporter: rabbitmq
  project_id: marie-extract
  worker:
    enabled: true
  postgres:
    <<: *psql_conf_shared
    schema: marie_scheduler
  rabbitmq:
    <<: *rabbitmq_conf_shared
    exchange: llm-events
  clickhouse:
    host: localhost
    port: 9000
    database: marie

# FLOW / GATEWAY configuration
with:
  protocol:
    - grpc

  discovery: true
  discovery_host: 0.0.0.0 # SINGLE HOST OR A LIST OF HOSTS
  discovery_port: 2379
  discovery_watchdog_interval: 5 # DEPRECATED replace by discovery_heartbeat_sec
  discovery_service_name: gateway/marie
  discovery_namespace: marie
  discovery_lease_sec: 6
  discovery_heartbeat_sec: 1.5
  discovery_timeout_sec: 10
  discovery_retry_times : 5

#  discovery_ca_cert: "/path/to/ca.crt"
#  discovery_cert_key: "/path/to/client.key"
#  discovery_cert_cert: "/path/to/client.crt"
#  discovery_grpc_options: "grpc.keepalive_time_ms:30000,grpc.keepalive_timeout_ms:5000"

  discovery_ca_cert:
  discovery_cert_key:
  discovery_cert_cert:
  discovery_grpc_options:

  kv_store_kwargs:
    provider: postgresql
    hostname: 127.0.0.1
    port: 5432
    username: postgres
    password: '123456'
    database: postgres
    schema: marie_scheduler
    default_table: kv_store_worker
    max_pool_size: 5
    max_connections: 5

  discovery_kwargs:
    endpoints: 127.0.0.1:2379,192.168.1.1:2379


#  host: 127.0.0.1
  host: 0.0.0.0

# monitoring done by grafana/prometheus has been deprecated in favor of open-telemetry
#  monitoring: false
#  port_monitoring: 57843
  tracing: False
  traces_exporter_host: http://0.0.0.0
  traces_exporter_port: 4317
  metrics: False
  metrics_exporter_host: http://0.0.0.0
  metrics_exporter_port: 4317
  event_tracking: True

  expose_endpoints:
    /document/process:
      methods: ["POST"]
      summary: Process document
      tags:
        - document

prefetch: 4

# Multiple mock executors with different configurations for scheduler testing
executors:
  # Fast, reliable executor
  - name: mock_executor_a
    uses:
      jtype: IntegrationExecutorMock
      with:
        process_time: 1.0
        failure_rate: 0.0
        failure_mode: none #timeout
        storage:
          psql:
            <<: *psql_conf_shared
            enabled: True
          s3:
            <<: *s3_conf_shared
            enabled: True
      metas:
        py_modules:
          - marie.executor.mock
    timeout_ready: 3000000
    replicas: 2

  # Medium speed, reliable executor
  - name: mock_executor_b
    uses:
      jtype: IntegrationExecutorMock
      with:
        process_time: 2.0
        failure_rate: 0.0
        failure_mode: none #timeout
        storage:
          psql:
            <<: *psql_conf_shared
            enabled: True
          s3:
            <<: *s3_conf_shared
            enabled: True
      metas:
        py_modules:
          - marie.executor.mock
    timeout_ready: 3000000
    replicas: 2

  # Standard speed, reliable executor
  - name: mock_executor_c
    uses:
      jtype: IntegrationExecutorMock
      with:
        process_time: 3.0
        failure_rate: 0.0
        failure_mode: none #timeout
        storage:
          psql:
            <<: *psql_conf_shared
            enabled: True
          s3:
            <<: *s3_conf_shared
            enabled: True
      metas:
        py_modules:
          - marie.executor.mock
    timeout_ready: 3000000
    replicas: 2

  # Slow executor (for SLA testing)
  - name: mock_executor_d
    uses:
      jtype: IntegrationExecutorMock
      with:
        process_time: 5.0
        failure_rate: 0.0
        failure_mode: none #timeout
        storage:
          psql:
            <<: *psql_conf_shared
            enabled: True
          s3:
            <<: *s3_conf_shared
            enabled: True
      metas:
        py_modules:
          - marie.executor.mock
    timeout_ready: 3000000
    replicas: 2

  # Fast but occasionally flaky executor
  - name: mock_executor_e
    uses:
      jtype: IntegrationExecutorMock
      with:
        process_time: 1.5
        failure_rate: 0.1  # 10% failure rate
        failure_mode: none #timeout
        storage:
          psql:
            <<: *psql_conf_shared
            enabled: True
          s3:
            <<: *s3_conf_shared
            enabled: True
      metas:
        py_modules:
          - marie.executor.mock
    timeout_ready: 3000000
    replicas: 2

  # Medium speed, moderately flaky executor
  - name: mock_executor_f
    uses:
      jtype: IntegrationExecutorMock
      with:
        process_time: 3.0
        failure_rate: 0.2  # 20% failure rate
        failure_mode: none #timeout #random
        storage:
          psql:
            <<: *psql_conf_shared
            enabled: True
          s3:
            <<: *s3_conf_shared
            enabled: True
      metas:
        py_modules:
          - marie.executor.mock
    timeout_ready: 3000000
    replicas: 2

  # Very slow executor (for timeout testing)
  - name: mock_executor_g
    uses:
      jtype: IntegrationExecutorMock
      with:
        process_time: 8.0
        failure_rate: 0.0
        failure_mode: none #timeout
        storage:
          psql:
            <<: *psql_conf_shared
            enabled: True
          s3:
            <<: *s3_conf_shared
            enabled: True
      metas:
        py_modules:
          - marie.executor.mock
    timeout_ready: 3000000
    replicas: 2

  # Very flaky executor (for error recovery testing)
  - name: mock_executor_h
    uses:
      jtype: IntegrationExecutorMock
      with:
        process_time: 2.0
        failure_rate: 0.5  # 50% failure rate
        failure_mode: none #timeout #random
        storage:
          psql:
            <<: *psql_conf_shared
            enabled: True
          s3:
            <<: *s3_conf_shared
            enabled: True
      metas:
        py_modules:
          - marie.executor.mock
    timeout_ready: 3000000
    replicas: 2

# Authentication and Authorization configuration
auth:
  keys:
    - name : service-A
      api_key : mas_0aPJ9Q9nUO1Ac1vJTfffXEXs9FyGLf9BzfYgZ_RaHm707wmbfHJNPQ
      enabled : True
      roles : [admin, user]

    - name : service-B
      api_key : mau_t6qDi1BcL1NkLI8I6iM8z1va0nZP01UQ6LWecpbDz6mbxWgIIIZPfQ
      enabled : True
      roles : [admin, user]

# =============================================================================
# SCHEDULER TESTING CONFIGURATION
# =============================================================================
#
# This configuration creates 8 mock executors with different characteristics:
#
# mock_executor_a: Fast (1.0s), 0% failure - Baseline for performance
# mock_executor_b: Medium (2.0s), 0% failure - Standard processing
# mock_executor_c: Normal (3.0s), 0% failure - Default behavior
# mock_executor_d: Slow (5.0s), 0% failure - SLA boundary testing
# mock_executor_e: Fast (1.5s), 10% failure - Light flakiness
# mock_executor_f: Normal (3.0s), 20% failure - Moderate flakiness
# mock_executor_g: Very slow (8.0s), 0% failure - Timeout testing
# mock_executor_h: Medium (2.0s), 50% failure - Heavy error testing
#
# Use this config with the mock_parallel_subgraphs query plan to test:
# - Parallel subgraph execution
# - SLA enforcement across different executors
# - Error handling and retry logic
# - Resource allocation and scheduling
# - Job distribution performance
#
# =============================================================================
