"use strict";(self.webpackChunkmare_ai=self.webpackChunkmare_ai||[]).push([[9718],{28453:(e,n,i)=>{i.d(n,{R:()=>a,x:()=>o});var r=i(96540);const s={},t=r.createContext(s);function a(e){const n=r.useContext(t);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),r.createElement(t.Provider,{value:n},e.children)}},33934:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>a,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"extract/component-registry","title":"Component Registry","description":"This guide explains how to use, extend, and operate the ComponentRegistry responsible for discovery and orchestration of extraction components.","source":"@site/docs/extract/component-registry.md","sourceDirName":"extract","slug":"/extract/component-registry","permalink":"/docs/extract/component-registry","draft":false,"unlisted":false,"editUrl":"https://github.com/marieai/marie-ai/tree/main/docs/docs/extract/component-registry.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"validators","permalink":"/docs/extract/validators/"},"next":{"title":"Extract Engine \u2014 Entry Point","permalink":"/docs/extract/extract-overview"}}');var s=i(74848),t=i(28453);const a={},o="Component Registry",l={},c=[{value:"Purpose",id:"purpose",level:2},{value:"What it manages",id:"what-it-manages",level:2},{value:"Thread-safety",id:"thread-safety",level:2},{value:"Initialization modes",id:"initialization-modes",level:2},{value:"Wheel-based dynamic loading",id:"wheel-based-dynamic-loading",level:2},{value:"Registration API",id:"registration-api",level:2},{value:"Examples",id:"examples",level:3},{value:"Configuration-driven initialization",id:"configuration-driven-initialization",level:2},{value:"Logging and diagnostics",id:"logging-and-diagnostics",level:2},{value:"Error handling",id:"error-handling",level:2},{value:"Best practices",id:"best-practices",level:2},{value:"Common usage patterns",id:"common-usage-patterns",level:2}];function d(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,t.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"component-registry",children:"Component Registry"})}),"\n",(0,s.jsx)(n.p,{children:"This guide explains how to use, extend, and operate the ComponentRegistry responsible for discovery and orchestration of extraction components.\nIt covers responsibilities, registration/lookup APIs, initialization flows, wheel-based dynamic loading, thread-safety, configuration, and best practices."}),"\n",(0,s.jsx)(n.h2,{id:"purpose",children:"Purpose"}),"\n",(0,s.jsx)(n.p,{children:"ComponentRegistry is a thin facade that composes the following component types:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Parsers"}),"\n",(0,s.jsx)(n.li,{children:"Validators"}),"\n",(0,s.jsx)(n.li,{children:"Template builders"}),"\n",(0,s.jsx)(n.li,{children:"Region processors"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"It provides:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"A unified registration API (decorators) for each component type"}),"\n",(0,s.jsx)(n.li,{children:"Lazy initialization and auto-loading of core components"}),"\n",(0,s.jsx)(n.li,{children:"Support for dynamically loading external components (module scanning and Python wheels)"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"what-it-manages",children:"What it manages"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Parsers: Callable interfaces used to transform inputs into structured outputs."}),"\n",(0,s.jsx)(n.li,{children:"Validators: Instances of BaseValidator that can support different ValidationStage values."}),"\n",(0,s.jsx)(n.li,{children:"Template builders: Functions that build structured templates used by the pipeline."}),"\n",(0,s.jsx)(n.li,{children:"Region processors: Function or class-based processors for structured regions."}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Region processors can be registered as:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"A function"}),"\n",(0,s.jsx)(n.li,{children:"A class implementing the RegionProcessorProto with a process(...) method"}),"\n",(0,s.jsx)(n.li,{children:"A class type that implements the protocol (will be coerced to a callable)"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"The coerces ensure uniform call semantics regardless of function/class form."}),"\n",(0,s.jsx)(n.h2,{id:"thread-safety",children:"Thread-safety"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"All mutation and most reads are guarded by an internal RLock, ensuring safe concurrent access in multi-threaded environments."}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"initialization-modes",children:"Initialization modes"}),"\n",(0,s.jsx)(n.p,{children:"There are three key initialization flows:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Core components (auto-loaded by default)"}),"\n"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"On first component access or when initialize_core_components() is called, core modules are imported for their side effects (they register themselves using the decorators)."}),"\n",(0,s.jsx)(n.li,{children:"Controlled by auto_load_core flag (true by default)."}),"\n"]}),"\n",(0,s.jsxs)(n.ol,{start:"2",children:["\n",(0,s.jsx)(n.li,{children:"External components via module import"}),"\n"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"initialize_external_components(modules, strict=True) imports submodules beneath provided roots."}),"\n",(0,s.jsx)(n.li,{children:"strict=True raises on any failed import; strict=False logs failures and continues."}),"\n"]}),"\n",(0,s.jsxs)(n.ol,{start:"3",children:["\n",(0,s.jsx)(n.li,{children:"Configuration-driven initialization"}),"\n"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["initialize_from_config(config) supports:","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"load_core_components: bool (default: true)"}),"\n",(0,s.jsx)(n.li,{children:"external_component_modules: List[str] (module roots to scan)"}),"\n",(0,s.jsx)(n.li,{children:"wheel_directories: List[str] (directories to scan/install wheels from)"}),"\n",(0,s.jsx)(n.li,{children:"watch_wheels: bool (default: true) to watch the directories for new wheels"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Returns a summary dict with loaded/failed modules and totals per component type. May include wheel_results if any were processed."}),"\n",(0,s.jsx)(n.h2,{id:"wheel-based-dynamic-loading",children:"Wheel-based dynamic loading"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["The registry integrates with a wheel manager and a directory watcher to:","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Install existing wheels on startup for configured directories"}),"\n",(0,s.jsx)(n.li,{children:"Optionally watch directories for new wheels and load them dynamically"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["get_registry_info() exposes:","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"installed_wheels metadata (package name, modules_count, install_time)"}),"\n",(0,s.jsx)(n.li,{children:"watched_directories"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Note: cleanup() stops watchers and cleans the wheel manager."}),"\n",(0,s.jsx)(n.h2,{id:"registration-api",children:"Registration API"}),"\n",(0,s.jsx)(n.p,{children:"Use decorators exposed at module level for convenience:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"register_parser(name)"}),"\n",(0,s.jsx)(n.li,{children:"register_validator(name)"}),"\n",(0,s.jsx)(n.li,{children:"register_template_builder(name)"}),"\n",(0,s.jsx)(n.li,{children:"register_region_processor(name)"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Or use methods on a ComponentRegistry instance."}),"\n",(0,s.jsx)(n.p,{children:"Behavior:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Parsers: duplicate names log a warning and overwrite"}),"\n",(0,s.jsx)(n.li,{children:"Validators: duplicate names raise an error (BadConfigSource)"}),"\n",(0,s.jsx)(n.li,{children:"Template builders: duplicate names raise an error (BadConfigSource)"}),"\n",(0,s.jsx)(n.li,{children:"Region processors: duplicate names log a warning and overwrite"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"You can also register a validator instance directly:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"register_validator_instance(validator: BaseValidator)"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"examples",children:"Examples"}),"\n",(0,s.jsx)(n.p,{children:"Register a parser:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'\nfrom marie.extract.registry.base import register_parser\n\n@register_parser("my_parser")\ndef my_parser(context, input_data):\n    # parsing logic\n    return {"ok": True}\n'})}),"\n",(0,s.jsx)(n.p,{children:"Register a validator (factory/class/instance supported via coercion):"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'\nfrom marie.extract.registry.base import register_validator\nfrom marie.extract.validator.base import BaseValidator, ValidationStage\n\nclass MyValidator(BaseValidator):\n    name = "my_validator"\n    def supports_stage(self, stage: ValidationStage) -> bool:\n        return stage == ValidationStage.POST\n    def validate(self, data):\n        # validation logic\n        return []\n\n@register_validator("my_validator")\nclass MyValidatorFactory:\n    # returned/constructed object must be a BaseValidator-compatible instance\n    def __call__(self):\n        return MyValidator()\n'})}),"\n",(0,s.jsx)(n.p,{children:"Register a template builder:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'\nfrom marie.extract.registry.base import register_template_builder\n\n@register_template_builder("invoice_template")\ndef build_invoice_template(config):\n    return {"template": "invoice", "config": config}\n'})}),"\n",(0,s.jsx)(n.p,{children:"Register a region processor (function form):"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'\nfrom marie.extract.registry.base import register_region_processor\n\n@register_region_processor("remarks_processor")\ndef remarks_processor(context, parent_section, region_parser_config, regions_config):\n    # produce structured region outputs\n    return [{"type": "remarks", "items": []}]\n'})}),"\n",(0,s.jsx)(n.p,{children:"Register a region processor (class form, Protocol):"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'\nfrom marie.extract.registry.base import register_region_processor\n\n@register_region_processor("totals_processor")\nclass TotalsProcessor:\n    def process(self, context, parent_section, region_parser_config, regions_config):\n        # class-based processing\n        return [{"type": "totals", "items": []}]\n'})}),"\n",(0,s.jsx)(n.h2,{id:"configuration-driven-initialization",children:"Configuration-driven initialization"}),"\n",(0,s.jsx)(n.p,{children:"Call initialize_from_config(config: Dict[str, Any])."}),"\n",(0,s.jsx)(n.p,{children:"Supported keys:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"load_core_components: bool (default true)"}),"\n",(0,s.jsx)(n.li,{children:"external_component_modules: List[str] (module roots scanned for components that register themselves)"}),"\n",(0,s.jsx)(n.li,{children:"wheel_directories: List[str] (directories to scan for .whl files and install)"}),"\n",(0,s.jsx)(n.li,{children:"watch_wheels: bool (default true)"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Returns a dict summary with:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"loaded: List[str] loaded module names"}),"\n",(0,s.jsx)(n.li,{children:"failed: List[Tuple[module, error]]"}),"\n",(0,s.jsx)(n.li,{children:"total_parsers, total_validators, total_template_builders, total_region_processors"}),"\n",(0,s.jsx)(n.li,{children:"wheel_results: optional, per-directory installation outcomes"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Example:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'from marie.extract.registry.base import component_registry\n\nsummary = component_registry.initialize_from_config({\n    "load_core_components": True,\n    "external_component_modules": [\n        "my_company.marie_ext.parsers",\n        "my_company.marie_ext.validators",\n    ],\n    "wheel_directories": ["/opt/marie/wheels"],\n    "watch_wheels": True,\n})\n'})}),"\n",(0,s.jsx)(n.h2,{id:"logging-and-diagnostics",children:"Logging and diagnostics"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Registration logs at info/debug with component name and class/type"}),"\n",(0,s.jsx)(n.li,{children:"Missing lookups log a warning with available names"}),"\n",(0,s.jsx)(n.li,{children:"External loading logs loaded/failed counts; strict mode raises on failure"}),"\n",(0,s.jsx)(n.li,{children:"get_registry_info() provides a snapshot for UI/telemetry/health checks"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"error-handling",children:"Error handling"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Duplicate validator or template builder registrations raise BadConfigSource"}),"\n",(0,s.jsx)(n.li,{children:"External loading in strict mode raises BadConfigSource on any failure"}),"\n",(0,s.jsx)(n.li,{children:"Wheel handling exceptions are logged per directory and included in results"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"best-practices",children:"Best practices"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Use descriptive, stable names for components; they become public contract keys in configs"}),"\n",(0,s.jsx)(n.li,{children:"Avoid name collisions; treat validator and template builder names as unique"}),"\n",(0,s.jsx)(n.li,{children:"Keep region processor interfaces stable; prefer class-based processors for complex logic"}),"\n",(0,s.jsx)(n.li,{children:"Use strict=True during CI to catch failing external component imports early"}),"\n",(0,s.jsx)(n.li,{children:"Expose get_registry_info() in telemetry endpoints for visibility"}),"\n",(0,s.jsxs)(n.li,{children:["When developing dynamic components:","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Test against a scratch wheel directory"}),"\n",(0,s.jsx)(n.li,{children:"Enable watch_wheels for local iteration"}),"\n",(0,s.jsx)(n.li,{children:"Use logging to verify registrations happened"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"common-usage-patterns",children:"Common usage patterns"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Feature toggling: Register multiple parsers/validators and select by name via config"}),"\n",(0,s.jsx)(n.li,{children:"Multi-tenant: Load tenant-specific component modules via initialize_external_components"}),"\n",(0,s.jsx)(n.li,{children:"Runtime extension: Drop a new wheel in a watched directory to provision components without restart"}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}}}]);