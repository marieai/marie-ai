"use strict";(self.webpackChunkmare_ai=self.webpackChunkmare_ai||[]).push([[4025],{28453:(e,s,n)=>{n.d(s,{R:()=>i,x:()=>a});var r=n(96540);const t={},o=r.createContext(t);function i(e){const s=r.useContext(o);return r.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function a(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:i(e.components),r.createElement(o.Provider,{value:s},e.children)}},80292:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>l,contentTitle:()=>a,default:()=>h,frontMatter:()=>i,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"getting-started/deployment/control-plane","title":"Control Plane","description":"Control plane is responsible for orchestrating communication between nodes in the cluster.","source":"@site/docs/getting-started/deployment/control-plane.md","sourceDirName":"getting-started/deployment","slug":"/getting-started/deployment/control-plane","permalink":"/docs/getting-started/deployment/control-plane","draft":false,"unlisted":false,"editUrl":"https://github.com/marieai/marie-ai/tree/main/docs/docs/getting-started/deployment/control-plane.md","tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"sidebar_position":2},"sidebar":"tutorialSidebar","previous":{"title":"Docker - Single node","permalink":"/docs/getting-started/deployment/docker"},"next":{"title":"Observability","permalink":"/docs/getting-started/deployment/observability"}}');var t=n(74848),o=n(28453);const i={sidebar_position:2},a="Control Plane",l={},c=[{value:"Docker Compose",id:"docker-compose",level:2},{value:"User and permission setup",id:"user-and-permission-setup",level:3},{value:"Networking setup",id:"networking-setup",level:3},{value:"Starting and stopping Control Plane",id:"starting-and-stopping-control-plane",level:3},{value:"Controller(Traefik, Consul, RabbitMQ, Prometheus, Alertmanager, Loki, Grafana)",id:"controllertraefik-consul-rabbitmq-prometheus-alertmanager-loki-grafana",level:4},{value:"Storage",id:"storage",level:4},{value:"Kubernetes",id:"kubernetes",level:2},{value:"Services",id:"services",level:2},{value:"Logging queries",id:"logging-queries",level:2}];function d(e){const s={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,o.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(s.header,{children:(0,t.jsx)(s.h1,{id:"control-plane",children:"Control Plane"})}),"\n",(0,t.jsx)(s.p,{children:"Control plane is responsible for orchestrating communication between nodes in the cluster."}),"\n",(0,t.jsx)(s.h2,{id:"docker-compose",children:"Docker Compose"}),"\n",(0,t.jsxs)(s.p,{children:["Quickest way to bootstrap control plane is via ",(0,t.jsx)(s.code,{children:"docker compose"}),"."]}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:["Install new version of ",(0,t.jsx)(s.a,{href:"https://docs.docker.com/engine/install/ubuntu/#set-up-the-repository",children:"docker"})]}),"\n",(0,t.jsxs)(s.li,{children:["Install new version of ",(0,t.jsx)(s.a,{href:"https://docs.docker.com/compose/install/",children:"docker compose cli plugin"})]}),"\n"]}),"\n",(0,t.jsx)(s.h3,{id:"user-and-permission-setup",children:"User and permission setup"}),"\n",(0,t.jsxs)(s.p,{children:["The container is setup with ",(0,t.jsx)(s.code,{children:"app-svc"})," account so for that we will setup same account in the host system."]}),"\n",(0,t.jsxs)(s.p,{children:["Setting up user, for more info visit ",(0,t.jsx)(s.a,{href:"https://docs.docker.com/engine/install/linux-postinstall/#manage-docker-as-a-non-root-user",children:"Manage Docker as a non-root user"})]}),"\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.code,{children:"uid"})," is a number associated with a user account and ",(0,t.jsx)(s.code,{children:"gid"})," is a number associated with a group\nAssigned ID that are mapped from within the container to outside world."]}),"\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.code,{children:"431"})," : UID\n",(0,t.jsx)(s.code,{children:"433"})," : GUI"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-shell",children:"sudo groupadd -r app-svc -g 433\nsudo useradd -u 431 --comment 'app-svc' --create-home app-svc  --shell /usr/sbin/nologin -g app-svc\nsudo usermod -aG docker app-svc\n"})}),"\n",(0,t.jsx)(s.p,{children:"You can verify the user\u2019s UID, using the id command:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-shell",children:"$ id -u app-svc\n"})}),"\n",(0,t.jsx)(s.p,{children:"Directory structure, this is more of a convention than requirement."}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-sh",children:"sudo mkdir -p /opt/containers/apps/marie-ai\nsudo mkdir -p /opt/containers/config/marie-ai\n"})}),"\n",(0,t.jsxs)(s.p,{children:["Change permissions to ",(0,t.jsx)(s.code,{children:"app"})," and ",(0,t.jsx)(s.code,{children:"config"})]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-shell",children:"cd /opt/containers\nsudo chown app-svc:app-svc apps/ -R\nsudo chown app-svc:app-svc config/ -R\n"})}),"\n",(0,t.jsxs)(s.p,{children:["Now that we have our directory and permissions setup we can move on and setup the container.\nThe easiest way to manage container is by checking out the ",(0,t.jsx)(s.a,{href:"https://github.com/gregbugaj/marie-ai.git",children:"Marie-AI project"})]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-shell",children:"sudo su app-svc\ngit clone https://github.com/marieai/marie-ai\n"})}),"\n",(0,t.jsx)(s.h3,{id:"networking-setup",children:"Networking setup"}),"\n",(0,t.jsxs)(s.p,{children:["The configuration uses custom bridge networks called ",(0,t.jsx)(s.code,{children:"public"})," which we will create first."]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-shell",children:"docker network create --driver=bridge public\n\n# If you receive following error, enable IPv4 forwarding\n# WARNING: IPv4 forwarding is disabled. Networking will not work.\nsysctl net.ipv4.conf.all.forwarding=1\n"})}),"\n",(0,t.jsx)(s.h3,{id:"starting-and-stopping-control-plane",children:"Starting and stopping Control Plane"}),"\n",(0,t.jsx)(s.p,{children:"All service could be started with single command and run on the same host, however, for production setup it is recommended to run storage service on separate host."}),"\n",(0,t.jsx)(s.h4,{id:"controllertraefik-consul-rabbitmq-prometheus-alertmanager-loki-grafana",children:"Controller(Traefik, Consul, RabbitMQ, Prometheus, Alertmanager, Loki, Grafana)"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-shell",children:"docker compose  --env-file ./config/.env.prod -f docker-compose.yml --project-directory . up  --build --remove-orphans\n"})}),"\n",(0,t.jsx)(s.h4,{id:"storage",children:"Storage"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-shell",children:"docker compose  --env-file ./config/.env.prod -f docker-compose.s3.yml -f docker-compose.storage.yml --project-directory . up  --build --remove-orphans\n"})}),"\n",(0,t.jsxs)(s.p,{children:["After S3 is up and running we can mount via ",(0,t.jsx)(s.code,{children:"s3fs"})," and test it out."]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-shell",children:"chmod 600 ~/.passwd-s3f\ns3fs marie /mnt/s3-marie -o passwd_file=${HOME}/.passwd-s3fs -o url=http://127.0.0.1:8000  -o allow_other -o use_path_request_style  -o dbglevel=info -f -o curldbg\n"})}),"\n",(0,t.jsxs)(s.p,{children:["Edit ",(0,t.jsx)(s.code,{children:"/etc/fuse.conf"})," and enable ",(0,t.jsx)(s.code,{children:"allow_other"})]}),"\n",(0,t.jsxs)(s.p,{children:["Sample ",(0,t.jsx)(s.code,{children:".passwd-s3fs"})]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-text",children:"MARIEACCESSKEY:MARIESECRETACCESSKEY\n"})}),"\n",(0,t.jsx)(s.p,{children:"Starting and stopping specific services"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-shell",children:"docker compose down \\ \ndocker compose -f docker-compose.yml -f docker-compose.storage.yml \\\n--project-directory . up loki consul-server grafana prometheus traefik whoami  --build  --remove-orphans\n"})}),"\n",(0,t.jsx)(s.h2,{id:"kubernetes",children:"Kubernetes"}),"\n",(0,t.jsx)(s.p,{children:(0,t.jsx)(s.a,{href:"https://kubernetes.io/docs/tasks/configure-pod-container/translate-compose-kubernetes/",children:"Translate a Docker Compose File to Kubernetes Resources"})}),"\n",(0,t.jsx)(s.h2,{id:"services",children:"Services"}),"\n",(0,t.jsx)(s.p,{children:"There are number of services that made up control plane."}),"\n",(0,t.jsxs)(s.admonition,{title:"SSH Port Forwarding",type:"info",children:[(0,t.jsxs)(s.p,{children:["Some admin service can only be accesses via ",(0,t.jsx)(s.code,{children:"localhost"})," host. We will use SSH forwarding to allow this from our local machine to control-plane."]}),(0,t.jsxs)(s.p,{children:["Replace ",(0,t.jsx)(s.code,{children:"ops-001"})," with the name of the control plane server.\nAlternatively you can edit ",(0,t.jsx)(s.code,{children:"/etc/hosts"})," and add custom hostname."]}),(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-shell",children:"172.0.0.1   ops-001.marie-ai.com\n172.0.0.1   ops-001\n"})}),(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-shell",children:"ssh -vnT -N -L 15672:ops-001:15672 -L 8500:ops-001:8500 -L 5000:ops-001:5000  -L 7777:ops-001:7777 -L 9090:ops-001:9090 -L 3000:ops-001:3000 -L 3100:ops-001:3100 -L 9093:ops-001:9093 ops-001\n"})}),(0,t.jsx)(s.p,{children:(0,t.jsx)(s.a,{href:"https://explainshell.com/explain?cmd=ssh+-N+-L+8500%3Aops-001%3A8500+-L+7777%3Aops-001%3A7777+-L+9090%3Aops-001%3A9090+-L+3000%3Aops-001%3A3000+ops-001",children:"Explain"})})]}),"\n",(0,t.jsxs)(s.table,{children:[(0,t.jsx)(s.thead,{children:(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.th,{children:"Service"}),(0,t.jsx)(s.th,{children:"Endpoint"}),(0,t.jsx)(s.th,{children:"Description"})]})}),(0,t.jsxs)(s.tbody,{children:[(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:"Consul"}),(0,t.jsx)(s.td,{children:(0,t.jsx)(s.a,{href:"http://localhost:8500/ui/",children:"http://localhost:8500/ui/"})}),(0,t.jsx)(s.td,{children:"Consul is a distributed, highly available, and data center aware solution to connect and configure applications across dynamic, distributed infrastructure."})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:"Traefik"}),(0,t.jsxs)(s.td,{children:[(0,t.jsx)(s.a,{href:"http://traefik.localhost:7777/dashboard/#/",children:"http://traefik.localhost:7777/dashboard/#/"})," ",(0,t.jsx)(s.a,{href:"http://traefik.localhost:7777/metrics",children:"http://traefik.localhost:7777/metrics"})]}),(0,t.jsx)(s.td,{children:"Traefik is a modern HTTP reverse proxy and load balancer that makes deploying microservices easy."})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:"RabbitMQ"}),(0,t.jsx)(s.td,{children:(0,t.jsx)(s.a,{href:"http://localhost:15672",children:"http://localhost:15672"})}),(0,t.jsx)(s.td,{children:"RabbitMQ message broker"})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:"Grafana"}),(0,t.jsx)(s.td,{children:(0,t.jsx)(s.a,{href:"http://localhost:3000/",children:"http://localhost:3000/"})}),(0,t.jsx)(s.td,{children:"The open and composable observability and data visualization platform."})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:"Prometheus"}),(0,t.jsx)(s.td,{children:(0,t.jsx)(s.a,{href:"http://localhost:9090/",children:"http://localhost:9090/"})}),(0,t.jsx)(s.td,{children:"The Prometheus monitoring system and time series database."})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:"Alertmanager"}),(0,t.jsx)(s.td,{children:(0,t.jsx)(s.a,{href:"http://localhost:9093/",children:"http://localhost:9093/"})}),(0,t.jsx)(s.td,{children:"The Alertmanager handles alerts sent by client applications such as the Prometheus server."})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:"Loki"}),(0,t.jsx)(s.td,{children:(0,t.jsx)(s.a,{href:"http://localhost:3100/ready",children:"http://localhost:3100/ready"})}),(0,t.jsx)(s.td,{children:"Loki is a horizontally scalable, highly available, multi-tenant log aggregation system inspired by Prometheus"})]})]})]}),"\n",(0,t.jsx)(s.p,{children:"Traefik - Service endpoints can be changed in the configs but by default they are as follow:"}),"\n",(0,t.jsxs)(s.table,{children:[(0,t.jsx)(s.thead,{children:(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.th,{children:"Traefik - Service"}),(0,t.jsx)(s.th,{children:"Endpoint"})]})}),(0,t.jsxs)(s.tbody,{children:[(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:"Dashboard"}),(0,t.jsx)(s.td,{children:(0,t.jsx)(s.a,{href:"http://traefik.localhost:7777/dashboard/#/",children:"http://traefik.localhost:7777/dashboard/#/"})})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:"traefik"}),(0,t.jsx)(s.td,{children:(0,t.jsx)(s.a,{href:"http://traefik.localhost:7777/",children:"http://traefik.localhost:7777/"})})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:"traefik-debug"}),(0,t.jsx)(s.td,{children:(0,t.jsx)(s.a,{href:"http://traefik.localhost:7000/",children:"http://traefik.localhost:7000/"})})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:"Service endpoint"}),(0,t.jsx)(s.td,{children:(0,t.jsx)(s.a,{href:"http://traefik.localhost:5000/",children:"http://traefik.localhost:5000/"})})]})]})]}),"\n",(0,t.jsxs)(s.admonition,{title:"Grafana Data Sources / Loki",type:"warning",children:[(0,t.jsxs)(s.p,{children:["When configuring Grafana Loki Datasource make sure to use the public ",(0,t.jsx)(s.code,{children:"IP"})," or ",(0,t.jsx)(s.code,{children:"hostname"})," and not loopback ip(127.0.0.1/localhost)\nin the HTTP URL field."]}),(0,t.jsxs)(s.p,{children:["Example\n",(0,t.jsx)(s.code,{children:"http://ops-001:3100"})]})]}),"\n",(0,t.jsx)(s.h2,{id:"logging-queries",children:"Logging queries"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-sql",children:'{job="marie-ai"} |= `` | json | line_format `{{.msg}}`\n'})}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-sql",children:'{job="marie-ai"} |= `` | json | levelname = `ERROR` | line_format `{{.msg}}`\n'})})]})}function h(e={}){const{wrapper:s}={...(0,o.R)(),...e.components};return s?(0,t.jsx)(s,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}}}]);