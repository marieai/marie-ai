"use strict";(self.webpackChunkmare_ai=self.webpackChunkmare_ai||[]).push([[7520],{22749:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>t,contentTitle:()=>c,default:()=>h,frontMatter:()=>a,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"getting-started/deployment/docker","title":"Docker - Single node","description":"Deployment single node via docker container","source":"@site/docs/getting-started/deployment/docker.md","sourceDirName":"getting-started/deployment","slug":"/getting-started/deployment/docker","permalink":"/docs/getting-started/deployment/docker","draft":false,"unlisted":false,"editUrl":"https://github.com/marieai/marie-ai/tree/main/docs/docs/getting-started/deployment/docker.md","tags":[],"version":"current","sidebarPosition":1,"frontMatter":{"sidebar_position":1},"sidebar":"tutorialSidebar","previous":{"title":"Deployment","permalink":"/docs/category/deployment"},"next":{"title":"Control Plane","permalink":"/docs/getting-started/deployment/control-plane"}}');var o=i(74848),s=i(28453);const a={sidebar_position:1},c="Docker - Single node",t={},l=[{value:"User and permission setup",id:"user-and-permission-setup",level:2},{value:"Basic Configuration",id:"basic-configuration",level:2},{value:"Directory layout",id:"directory-layout",level:3},{value:"Single-GPU",id:"single-gpu",level:4},{value:"Multi-GPU",id:"multi-gpu",level:4},{value:"Required configuration",id:"required-configuration",level:3},{value:"Application Logs with Docker",id:"application-logs-with-docker",level:2},{value:"Named volumes",id:"named-volumes",level:3},{value:"Bind Mount",id:"bind-mount",level:3},{value:"Permission setup : UID/GID",id:"permission-setup--uidgid",level:3},{value:"Container management",id:"container-management",level:2},{value:"Update container to specific version",id:"update-container-to-specific-version",level:3},{value:"Starting container",id:"starting-container",level:3},{value:"Manually starting container",id:"manually-starting-container",level:3},{value:"References",id:"references",level:3}];function d(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",p:"p",pre:"pre",strong:"strong",...(0,s.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.header,{children:(0,o.jsx)(n.h1,{id:"docker---single-node",children:"Docker - Single node"})}),"\n",(0,o.jsx)(n.p,{children:"Deployment single node via docker container"}),"\n",(0,o.jsx)(n.h2,{id:"user-and-permission-setup",children:"User and permission setup"}),"\n",(0,o.jsxs)(n.p,{children:["The container is setup with ",(0,o.jsx)(n.code,{children:"app-svc"})," account so for that we will setup same account in the host system."]}),"\n",(0,o.jsxs)(n.p,{children:["Setting up user, for more info visit ",(0,o.jsx)(n.a,{href:"https://docs.docker.com/engine/install/linux-postinstall/#manage-docker-as-a-non-root-user",children:"Manage Docker as a non-root user"})]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:"sudo groupadd -r app-svc -g 433\nsudo useradd -u 431 --comment 'app-svc' --create-home app-svc  --shell /usr/sbin/nologin\nsudo usermod -aG docker app-svc\n"})}),"\n",(0,o.jsx)(n.p,{children:"Directory structure, this is more of a convention than requirement."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:"sudo mkdir -p /opt/containers/apps/marie-ai\nsudo mkdir -p /opt/containers/config/marie-ai\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Change permissions to ",(0,o.jsx)(n.code,{children:"app"})," and ",(0,o.jsx)(n.code,{children:"config"})]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:"cd /opt/containers\nsudo chown app-svc:app-svc apps/ -R\nsudo chown app-svc:app-svc config/ -R\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Now that we have our directory and permissions setup we can move on and setup the container.\nThe easiest way to manage container is by checking out the ",(0,o.jsx)(n.a,{href:"https://github.com/gregbugaj/marie-ai.git",children:"Marie-AI project"})]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-sh",children:"sudo su app-svc\n\ngit clone https://github.com/gregbugaj/marie-ai.git\n"})}),"\n",(0,o.jsx)(n.h2,{id:"basic-configuration",children:"Basic Configuration"}),"\n",(0,o.jsxs)(n.admonition,{title:"Container Configuration",type:"warning",children:[(0,o.jsx)(n.p,{children:"This is a single node setup up without control-plane."}),(0,o.jsxs)(n.p,{children:["Complete configuration setup can be found under ",(0,o.jsx)(n.a,{href:"/docs/category/configuration",children:"Configuration"}),"."]})]}),"\n",(0,o.jsx)(n.p,{children:"Before we are able to start the container we need to configure few components."}),"\n",(0,o.jsx)(n.h3,{id:"directory-layout",children:"Directory layout"}),"\n",(0,o.jsxs)(n.p,{children:["This is the initial entrypoint for ",(0,o.jsx)(n.code,{children:"models"})," and ",(0,o.jsx)(n.code,{children:"config"}),", this can be changed by modifying ",(0,o.jsx)(n.code,{children:"run.sh"})," Directories will be mapped as volumes when the container is created."]}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.em,{children:(0,o.jsx)(n.strong,{children:"TODO : this needs to be configurable via ENV variables"})})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:"/mnt/data/marie-a\n/opt/logs/marie-icr\n"})}),"\n",(0,o.jsx)(n.h4,{id:"single-gpu",children:"Single-GPU"}),"\n",(0,o.jsx)(n.p,{children:"On a single GPU the directory structure should loook like following"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"/mnt/data/marie-ai/\n\u251c\u2500\u2500 config\n\u2502\xa0\xa0 \u251c\u2500\u2500 consul\n\u2502\xa0\xa0 \u251c\u2500\u2500 executors\n\u2502\xa0\xa0 \u251c\u2500\u2500 ocr\n\u2502\xa0\xa0 \u2514\u2500\u2500 traefik\n\u2502\xa0\xa0     \u2514\u2500\u2500 log\n\u2514\u2500\u2500 model_zoo\n"})}),"\n",(0,o.jsx)(n.h4,{id:"multi-gpu",children:"Multi-GPU"}),"\n",(0,o.jsx)(n.p,{children:"If the system support muli-gpus then we can configure the system to take advanate of that. Configuration is almost identical to single gpu.\nFor each GPU we adappend GPU-ID to the config directory names"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"/mnt/data/marie-ai/\n\u251c\u2500\u2500 config-0\n\u2502\xa0\xa0 \u251c\u2500\u2500 consul\n\u2502\xa0\xa0 \u251c\u2500\u2500 ocr\n\u2502\xa0\xa0 \u2514\u2500\u2500 traefik\n\u251c\u2500\u2500 config-1\n\u2502\xa0\xa0 \u251c\u2500\u2500 consul\n\u2502\xa0\xa0 \u251c\u2500\u2500 ocr\n\u2502\xa0\xa0 \u2514\u2500\u2500 traefik\n\u251c\u2500\u2500 config-2\n\u2502\xa0\xa0 \u251c\u2500\u2500 consul\n\u2502\xa0\xa0 \u251c\u2500\u2500 ocr\n\u2502\xa0\xa0 \u2514\u2500\u2500 traefik\n\u251c\u2500\u2500 config-3\n\u2502\xa0\xa0 \u251c\u2500\u2500 consul\n\u2502\xa0\xa0 \u251c\u2500\u2500 ocr\n\u2502\xa0\xa0 \u2514\u2500\u2500 traefik\n\u251c\u2500\u2500 config-template\n\u2502\xa0\xa0 \u251c\u2500\u2500 consul\n\u2502\xa0\xa0 \u251c\u2500\u2500 ocr\n\u2502\xa0\xa0 \u2514\u2500\u2500 traefik\n\u2514\u2500\u2500 model_zoo\n"})}),"\n",(0,o.jsx)(n.h3,{id:"required-configuration",children:"Required configuration"}),"\n",(0,o.jsxs)(n.p,{children:["The easiest way to initialize the configs is by copying them from the project ",(0,o.jsx)(n.code,{children:"config"})," directory."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"/mnt/data/marie-ai/config/marie.yml\n"})}),"\n",(0,o.jsx)(n.h2,{id:"application-logs-with-docker",children:"Application Logs with Docker"}),"\n",(0,o.jsx)(n.p,{children:"There are couple ways that we can log from within a container to outside world."}),"\n",(0,o.jsx)(n.h3,{id:"named-volumes",children:"Named volumes"}),"\n",(0,o.jsxs)(n.p,{children:["First option(default) is to use a ",(0,o.jsx)(n.code,{children:"docker volume"})," and create new named volume called ",(0,o.jsx)(n.code,{children:"marie_logs"})]}),"\n",(0,o.jsx)(n.admonition,{type:"info",children:(0,o.jsx)(n.p,{children:"This is preferred option for single node setups."})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:"sudo mkdir -p /var/log/marie-ai\nsudo chown app-svc:app-svc /var/log/marie-ai -R\n\ndocker volume create --driver local --name marie_logs --opt type=none --opt device=/var/log/marie-ai --opt o=uid=root,gid=root --opt o=bind\n"})}),"\n",(0,o.jsxs)(n.p,{children:["When we list the docker volumes we should see ",(0,o.jsx)(n.code,{children:"marie_logs"})," in the output."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:"$ docker volume ls\nDRIVER    VOLUME NAME\nlocal     marie_cache\nlocal     marie_logs\n"})}),"\n",(0,o.jsxs)(n.p,{children:["After the volume is created it can be mapped in the docker with the docker ",(0,o.jsx)(n.code,{children:"-v"})," flag.\nApplication will log by default to ",(0,o.jsx)(n.code,{children:"/home/app-svc/logs"})," directory, this can be changed by modifying ",(0,o.jsx)(n.code,{children:"resources/logging.default.yml"})]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:"-v marie_logs:/home/app-svc/logs\n"})}),"\n",(0,o.jsxs)(n.p,{children:["We can inspect the volume and display the mount points via ",(0,o.jsx)(n.code,{children:"docker volume inspect marie_logs"}),"."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:'$ docker volume inspect marie_logs \n[\n    {\n        "CreatedAt": "2022-10-28T23:11:05Z",\n        "Driver": "local",\n        "Labels": {},\n        "Mountpoint": "/var/lib/docker/volumes/marie_logs/_data",\n        "Name": "marie_logs",\n        "Options": {\n            "device": "/var/log/marie-ai",\n            "o": "bind",\n            "type": "none"\n        },\n        "Scope": "local"\n    }\n]\n\n'})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:"$ ls -lt /var/log/marie-ai/*\n-rw------- 1 root root    66 Oct 31 16:22 /var/log/marie-ai/ssh-agent-stderr---supervisor-ee3f8v_8.log\n-rw-r--r-- 1  431  433 45654 Oct 31 16:22 /var/log/marie-ai/marie-2022-10-31T16:17:53.299405.log\n-rw------- 1 root root    75 Oct 31 16:17 /var/log/marie-ai/ssh-agent-stdout---supervisor-gann9r5z.log\n"})}),"\n",(0,o.jsx)(n.h3,{id:"bind-mount",children:"Bind Mount"}),"\n",(0,o.jsx)(n.admonition,{type:"info",children:(0,o.jsx)(n.p,{children:"Preferred method for multi-node setup. This allows for better log segregation by GPU."})}),"\n",(0,o.jsx)(n.h3,{id:"permission-setup--uidgid",children:"Permission setup : UID/GID"}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.code,{children:"uid"})," is a number associated with a user account and ",(0,o.jsx)(n.code,{children:"gid"})," is a number associated with a group\nThe log directory needs to have the UID/GID of ",(0,o.jsx)(n.code,{children:"431:433"})]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:"$ id\nuid=431(app-svc) gid=433(app-svc) groups=433(app-svc),998(docker)\n"})}),"\n",(0,o.jsx)(n.p,{children:"IDs are coming the user setup."}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.code,{children:"431"})," : User ID given to ",(0,o.jsx)(n.code,{children:"app-svc"})," account\n",(0,o.jsx)(n.code,{children:"433"})," : Group ID given to ",(0,o.jsx)(n.code,{children:"app-svc"})," account"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:"sudo mkdir -p /var/log/marie-ai\nsudo chown app-svc:app-svc /var/log/marie-ai -R\n"})}),"\n",(0,o.jsx)(n.p,{children:"On a 4 GPU system the log directory should look like following, this includes couple log files."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:"$ tree /var/log/marie-ai\n/var/log/marie-ai/\n\u251c\u2500\u2500 0\n\u2502\xa0\xa0 \u251c\u2500\u2500 marie-2022-10-31T19:55:40.712174.log\n\u251c\u2500\u2500 1\n\u251c\u2500\u2500 2\n\u251c\u2500\u2500 3\n\u2502\xa0\xa0 \u251c\u2500\u2500 marie-2022-10-31T19:59:40.286707.log\n\u2514\u2500\u2500 all\n"})}),"\n",(0,o.jsxs)(n.p,{children:["After the directory s created it can be mapped in the docker with the docker ",(0,o.jsx)(n.code,{children:"-v"})," flag.\nApplication will log by default to ",(0,o.jsx)(n.code,{children:"/home/app-svc/logs"})," directory, this can be changed by modifying ",(0,o.jsx)(n.code,{children:"resources/logging.default.yml"})]}),"\n",(0,o.jsxs)(n.p,{children:["The ",(0,o.jsx)(n.code,{children:"$GPUS"})," variable will be set from shell script while executed."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:"-v /var/log/marie-ai/$GPUS:/home/app-svc/logs\n"})}),"\n",(0,o.jsx)(n.h2,{id:"container-management",children:"Container management"}),"\n",(0,o.jsxs)(n.p,{children:["To manage a container we have a set of scripts located in ",(0,o.jsx)(n.code,{children:"marie-ai/docker-util"})]}),"\n",(0,o.jsxs)(n.admonition,{title:"Changing container version",type:"info",children:[(0,o.jsxs)(n.p,{children:["To change container version edit ",(0,o.jsx)(n.code,{children:"id"})," file, it should contain a specific version that we like to use ",(0,o.jsx)(n.a,{href:"https://docs.docker.com/registry/",children:"Docker Registry"}),"."]}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"gregbugaj/marie-icr:2.4-cuda\n"})}),(0,o.jsx)(n.p,{children:"This could also include your specific registry as well."}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"localhost:5000/gregbugaj/marie-icr:2.4-cuda\n"})})]}),"\n",(0,o.jsx)(n.h3,{id:"update-container-to-specific-version",children:"Update container to specific version"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:"cd marie-ai/docker-util\n./update.sh\n"})}),"\n",(0,o.jsx)(n.h3,{id:"starting-container",children:"Starting container"}),"\n",(0,o.jsxs)(n.p,{children:["Start single ",(0,o.jsx)(n.code,{children:"marie-ai"})," container in interactive mode with ",(0,o.jsx)(n.strong,{children:"ALL GPUS"})," assigned to single instance"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"./run-interactive-gpu.sh\n"})}),"\n",(0,o.jsx)(n.p,{children:"You should see initial output :"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"Starting interactive/dev container : marie-icr\nGPU_COUNT : 4\nGPUS Selected  > all\nCONTAINER_NAME > marie-icr\nCONTAINER_ID   > \nCONFIG         > config\nPORT           > 6000\nCONFIG_DIR     > /mnt/data/marie-ai/config\n"})}),"\n",(0,o.jsx)(n.h3,{id:"manually-starting-container",children:"Manually starting container"}),"\n",(0,o.jsx)(n.p,{children:"Console mode"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:"docker run --gpus all --rm -it --name=marieai --network=host \\\n  -e JINA_LOG_LEVEL=debug \\\n  -e MARIE_DEFAULT_MOUNT='/etc/marie' \\\n  -v /mnt/data/marie-ai/config:/etc/marie/config:ro \\\n  -v /mnt/data/marie-ai/model_zoo:/etc/marie/model_zoo:rw \\\n  marieai/marie:4.0.0-cuda server --uses /etc/marie/config/service/marie.yml\n\n"})}),"\n",(0,o.jsx)(n.p,{children:"Daemon mode"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:"docker run --gpus all --name=marieai -d --network=host \\\n  -e JINA_LOG_LEVEL=debug \\\n  -e MARIE_DEFAULT_MOUNT='/etc/marie' \\\n  -v /mnt/data/marie-ai/config:/etc/marie/config:ro \\\n  -v /mnt/data/marie-ai/model_zoo:/etc/marie/model_zoo:rw \\\n  marieai/marie:4.0.0-cuda server --uses /etc/marie/config/service/marie.yml\n"})}),"\n",(0,o.jsx)(n.h3,{id:"references",children:"References"}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.a,{href:"https://docs.docker.com/storage/volumes/",children:"Docker volumes"}),"\n",(0,o.jsx)(n.a,{href:"https://docs.docker.com/storage/bind-mounts/",children:"Bind Mounts"})]})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},28453:(e,n,i)=>{i.d(n,{R:()=>a,x:()=>c});var r=i(96540);const o={},s=r.createContext(o);function a(e){const n=r.useContext(s);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:a(e.components),r.createElement(s.Provider,{value:n},e.children)}}}]);