# ############### MinIO S3 - Object Storage ###############
#
# Used by: marie-ai for document storage
#
# MinIO provides S3-compatible object storage for documents and artifacts.
#
# Prerequisites:
#   - Network created: docker network create --driver=bridge marie_default
#
# Usage:
#   docker compose --env-file ./config/.env -f ./Dockerfiles/docker-compose.s3.yml --project-directory . up -d
#
# Access:
#   - S3 API: http://localhost:8000
#   - Console UI: http://localhost:8001

services:
  s3server:
    image: minio/minio:latest
    container_name: marie-s3-server
    restart: unless-stopped
    ports:
      - "8000:8000"        # S3 API port
      - "8001:9001"        # MinIO Console UI
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
      # Disable server-side encryption to avoid KMS requirement
      SERVER_SIDE_ENCRYPTION: "off"
      # Explicitly disable all encryption features
      MINIO_KMS_AUTO_ENCRYPTION: "off"
    command: server /data --address ":8000" --console-address ":9001"
    volumes:
      - /mnt/data/s3:/data
    networks:
      - marie_default
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/minio/health/live"]
      interval: 10s
      timeout: 20s
      retries: 3

  mc-setup:
    image: minio/mc:latest
    container_name: marie-mc-setup
    depends_on:
      s3server:
        condition: service_healthy
    environment:
      MC_HOST_localminio: http://${MINIO_ROOT_USER}:${MINIO_ROOT_PASSWORD}@marie-s3-server:8000
    volumes:
      - mc-config:/root/.mc
    networks:
      - marie_default
    restart: "no"
    healthcheck:
      test: ["CMD", "mc", "alias", "list", "localminio"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 10s
    entrypoint: >
      /bin/sh -c "
      echo 'Starting MinIO setup...';
      mc alias set localminio http://marie-s3-server:8000 ${MINIO_ROOT_USER} ${MINIO_ROOT_PASSWORD};
      mc admin user add localminio ${MARIE_ACCESS_KEY} ${MARIE_SECRET_ACCESS_KEY} || echo 'User may already exist';
      mc admin policy attach localminio readwrite --user ${MARIE_ACCESS_KEY} || echo 'Policy may already be attached';
      mc mb localminio/marie --ignore-existing;
      mc encrypt clear localminio/marie 2>/dev/null || true;
      mc admin policy remove localminio default-encryption 2>/dev/null || true;
      echo 'MinIO setup completed successfully!';
      echo 'Setup container exiting...';
      "

  mc-client:
    image: minio/mc:latest
    container_name: marie-mc-client
    depends_on:
      - mc-setup
    volumes:
      - mc-config:/root/.mc
    networks:
      - marie_default
    profiles:
      - tools
    entrypoint: /bin/sh
    stdin_open: true
    tty: true

volumes:
  mc-config:

networks:
  marie_default:
    external: true