"use strict";(self.webpackChunkmare_ai=self.webpackChunkmare_ai||[]).push([[383],{28453:(e,c,t)=>{t.d(c,{R:()=>i,x:()=>d});var r=t(96540);const s={},n=r.createContext(s);function i(e){const c=r.useContext(n);return r.useMemo((function(){return"function"==typeof e?e(c):{...c,...e}}),[c,e])}function d(e){let c;return c=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),r.createElement(n.Provider,{value:c},e.children)}},88321:(e,c,t)=>{t.r(c),t.d(c,{assets:()=>a,contentTitle:()=>d,default:()=>h,frontMatter:()=>i,metadata:()=>r,toc:()=>o});const r=JSON.parse('{"id":"guides/service-discovery","title":"Service Discovery","description":"Service discovery is a mechanism that allows services to find and communicate with each other.","source":"@site/docs/guides/service-discovery.md","sourceDirName":"guides","slug":"/guides/service-discovery","permalink":"/docs/guides/service-discovery","draft":false,"unlisted":false,"editUrl":"https://github.com/marieai/marie-ai/tree/main/docs/docs/guides/service-discovery.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Template Matching","permalink":"/docs/guides/template_matching"},"next":{"title":"Models","permalink":"/docs/category/models"}}');var s=t(74848),n=t(28453);const i={},d="Service Discovery",a={},o=[{value:"Install etcd",id:"install-etcd",level:2},{value:"Purge the etcd data",id:"purge-the-etcd-data",level:2},{value:"Maitenance jobs",id:"maitenance-jobs",level:2},{value:"Install the <code>etcd3</code> package",id:"install-the-etcd3-package",level:2}];function l(e){const c={code:"code",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",...(0,n.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(c.header,{children:(0,s.jsx)(c.h1,{id:"service-discovery",children:"Service Discovery"})}),"\n",(0,s.jsxs)(c.p,{children:["Service discovery is a mechanism that allows services to find and communicate with each other.\nHere we are going to show how to use the ",(0,s.jsx)(c.code,{children:"EtcdServiceResolver"})," to resolve services from etcd."]}),"\n",(0,s.jsx)(c.h2,{id:"install-etcd",children:"Install etcd"}),"\n",(0,s.jsx)(c.pre,{children:(0,s.jsx)(c.code,{className:"language-bash",children:"docker run  -d  -p 2379:2379  --name etcd \\\n-v /usr/share/ca-certificates/:/etc/ssl/certs \\\nquay.io/coreos/etcd:v3.6.1 /usr/local/bin/etcd -advertise-client-urls \\\nhttp://0.0.0.0:2379 -listen-client-urls http://0.0.0.0:2379 \\\n--log-level=info \\\n--log-outputs=stdout\n"})}),"\n",(0,s.jsx)(c.p,{children:"Verify the installation by running the following command:"}),"\n",(0,s.jsx)(c.pre,{children:(0,s.jsx)(c.code,{className:"language-bash",children:"docker exec -it etcd etcdctl version\n"})}),"\n",(0,s.jsx)(c.pre,{children:(0,s.jsx)(c.code,{className:"language-bash",children:"docker exec -it etcd etcdctl put 'hello' 'value-1'\ndocker exec -it etcd etcdctl put 'world' 'value-2'\n \ndocker exec -it etcd etcdctl get \"\" --prefix=true\ndocker exec -it etcd etcdctl get \"\" --from-key\n"})}),"\n",(0,s.jsx)(c.p,{children:"Multinode etcd cluster:"}),"\n",(0,s.jsx)(c.pre,{children:(0,s.jsx)(c.code,{className:"language-bash",children:'docker exec -it etcd etcdctl --endpoints=mariectl-002:2379,mariectl-003:2379,mariectl-004:2379 get "" --prefix=true\n'})}),"\n",(0,s.jsx)(c.h1,{id:"mas_uslp7ulm7vytdcise8wo8n1yp99m4h0sb3bt5scbb_rzew6hfl3ytq",children:"mas_uSLP7ULm7vYTDCiSe8Wo8N1yP99m4H0sB3BT5sCbB_RzEw6HFL3yTQ"}),"\n",(0,s.jsx)(c.h1,{id:"mau_fonxom0vyfpvkrrojixpwgsiqoqxy1ikijmqttxzyk8yacj09cnhpw",children:"mau_fOnxOM0VYfPvKRrOJixpwgSiqOqXy1IKIjmqttXZyK8YACJ09CNhPw"}),"\n",(0,s.jsx)(c.h2,{id:"purge-the-etcd-data",children:"Purge the etcd data"}),"\n",(0,s.jsx)(c.pre,{children:(0,s.jsx)(c.code,{className:"language-bash",children:'docker exec -it etcd etcdctl del "" --from-key=true\n\ndocker exec -it etcd etcdctl --endpoints=mariectl-002:2379,mariectl-003:2379,mariectl-004:2379  del "" --from-key=true\n'})}),"\n",(0,s.jsx)(c.h2,{id:"maitenance-jobs",children:"Maitenance jobs"}),"\n",(0,s.jsx)(c.pre,{children:(0,s.jsx)(c.code,{className:"language-bash",children:"docker exec -it etcd etcdctl --endpoints=mariectl-001:2379 alarm list\ndocker exec -it etcd etcdctl --endpoints=mariectl-001:2379 defrag\n"})}),"\n",(0,s.jsxs)(c.h2,{id:"install-the-etcd3-package",children:["Install the ",(0,s.jsx)(c.code,{children:"etcd3"})," package"]}),"\n",(0,s.jsxs)(c.p,{children:["Install the ",(0,s.jsx)(c.code,{children:"etcd3"})," package from source code  as the ",(0,s.jsx)(c.code,{children:"GRPC"})," version or ",(0,s.jsx)(c.code,{children:"marie"})," is not compatible with the current version of the ",(0,s.jsx)(c.code,{children:"etcd3"})," package."]}),"\n",(0,s.jsx)(c.pre,{children:(0,s.jsx)(c.code,{className:"language-bash",children:"git clone  git@github.com:kragniz/python-etcd3.git\ncd python-etcd3\npython setup.py install\npip show etcd3\n"})}),"\n",(0,s.jsx)(c.h1,{id:"test-the-registry-and-resolver",children:"Test the registry and resolver"}),"\n",(0,s.jsx)(c.p,{children:"Start the resolver and the registry services."}),"\n",(0,s.jsx)(c.pre,{children:(0,s.jsx)(c.code,{className:"language-bash",children:"python ./marie/serve/discovery/resolver.py --port 2379 --host 0.0.0.0 --service-key gateway/service_test\n"})}),"\n",(0,s.jsx)(c.pre,{children:(0,s.jsx)(c.code,{className:"language-bash",children:"python ./registry.py --port 2379 --host 0.0.0.0 --service-key gateway/service_test --service-addr 127.0.0.1:5001 --my-id service001\n"})}),"\n",(0,s.jsx)(c.pre,{children:(0,s.jsx)(c.code,{className:"language-yaml",children:'  discovery: true\n  discovery_host: 127.0.0.1 # SINGLE HOST OR A LIST OF HOSTS\n  discovery_port: 2379\n  discovery_watchdog_interval: 5 # DEPRECATED replace by discovery_heartbeat_sec\n  discovery_service_name: gateway/marie\n  discovery_namespace: marie\n  discovery_lease_sec: 6\n  discovery_heartbeat_sec: 1.5\n  discovery_timeout_sec: 10\n  discovery_retry_times : 5\n\n#  discovery_ca_cert: "/path/to/ca.crt"\n#  discovery_cert_key: "/path/to/client.key"\n#  discovery_cert_cert: "/path/to/client.crt"\n#  discovery_grpc_options: "grpc.keepalive_time_ms:30000,grpc.keepalive_timeout_ms:5000"\n\n  discovery_ca_cert:\n  discovery_cert_key:\n  discovery_cert_cert:\n  discovery_grpc_options:\n'})})]})}function h(e={}){const{wrapper:c}={...(0,n.R)(),...e.components};return c?(0,s.jsx)(c,{...e,children:(0,s.jsx)(l,{...e})}):l(e)}}}]);